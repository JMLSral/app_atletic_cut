<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1.0,maximum-scale=1.0"
    />
    <title>Athletic Cut – UL + Dashboard</title>
    <meta name="theme-color" content="#050608" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="apple-mobile-web-app-title" content="Athletic Cut" />

    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }
      body {
        background: #050608;
        color: #f5f5f5;
      }
      header {
        padding: 14px;
        text-align: center;
        background: #111216;
        border-bottom: 1px solid #333;
      }
      header h1 {
        font-size: 1.35rem;
        margin-bottom: 4px;
      }
      header p {
        font-size: 0.85rem;
        color: #a9a9a9;
      }
      .tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        justify-content: center;
        margin-top: 8px;
      }
      .tab-btn {
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid #333743;
        background: #15161b;
        color: #ccc;
        font-size: 0.85rem;
        cursor: pointer;
      }
      .tab-btn.active {
        background: #e53935;
        color: #fff;
        border-color: #e53935;
      }
      main {
        padding: 12px;
        max-width: 1000px;
        margin: 0 auto 40px;
      }
      .card {
        background: #15161b;
        border: 1px solid #282a33;
        border-radius: 12px;
        padding: 12px 14px;
        margin-bottom: 12px;
      }
      .card h2 {
        font-size: 1.05rem;
        margin-bottom: 6px;
      }
      .sub {
        font-size: 0.85rem;
        color: #aeb4ba;
        margin-bottom: 6px;
      }
      select,
      input,
      textarea {
        width: 100%;
        padding: 8px;
        margin: 4px 0 10px;
        border-radius: 8px;
        border: 1px solid #333743;
        background: #111216;
        color: #f5f5f5;
      }
      textarea {
        min-height: 80px;
      }
      button {
        padding: 8px 12px;
        border-radius: 10px;
        border: none;
        background: #e53935;
        color: #fff;
        font-weight: 700;
        cursor: pointer;
      }
      button:hover {
        background: #ff5252;
      }
      button.secondary {
        background: #263238;
      }
      button.secondary:hover {
        background: #455a64;
      }
      .hidden {
        display: none;
      }
      .small {
        font-size: 0.8rem;
        color: #a9a9a9;
        margin-top: 4px;
      }

      /* RINGS DASHBOARD */
      .rings {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 18px;
        align-items: flex-start;
        margin-top: 6px;
      }
      .ring-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 0;
        text-align: center;
      }
      .ring-label {
        font-size: 0.9rem;
        color: #ddd;
        margin-bottom: 6px;
      }
      .ring {
        --percent: 0;
        --color: #e53935;
        width: 110px;
        height: 110px;
        border-radius: 50%;
        background: radial-gradient(
            circle at center,
            #15161b 55%,
            transparent 56%
          ),
          conic-gradient(
            var(--color) calc(var(--percent) * 360deg),
            #25262f calc(var(--percent) * 360deg)
          );
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 6px;
        box-shadow: 0 0 0 3px #050608, 0 0 18px rgba(0, 0, 0, 0.6);
        transition: background 0.35s ease-out;
      }
      .ring-inner {
        width: 74px;
        height: 74px;
        border-radius: 50%;
        background: linear-gradient(145deg, #15161b, #111116);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        color: #f5f5f5;
        box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.6);
      }
      .ring-value {
        font-size: 0.85rem;
        color: #cfd8dc;
      }
      .ring-value.small {
        font-size: 0.75rem;
        color: #9fa8b0;
        margin-top: -2px;
      }
      .history-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 8px;
        font-size: 0.8rem;
      }
      .history-table th,
      .history-table td {
        border: 1px solid #333743;
        padding: 4px 6px;
        text-align: center;
      }
      .history-table th {
        background: #22232b;
      }
      .view-toggle {
        display: flex;
        gap: 6px;
        margin-bottom: 8px;
      }
      .view-toggle button {
        flex: 1;
        font-size: 0.8rem;
      }

      /* GYM */
      .exercise-card {
        border: 1px solid #282a33;
        border-radius: 10px;
        padding: 10px;
        background: #111216;
        margin-bottom: 8px;
      }
      .exercise-header {
        display: flex;
        justify-content: space-between;
        gap: 8px;
      }
      .exercise-header-left {
        display: flex;
        flex-direction: column;
      }
      .exercise-meta {
        font-size: 0.75rem;
        color: #bfc5cc;
      }
      .exercise-inputs {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-top: 6px;
      }
      .sets-row {
        display: flex;
        gap: 6px;
      }
      .sets-row input {
        flex: 1;
        font-size: 0.85rem;
      }
      .tempo-note {
        font-size: 0.8rem;
        color: #cfd8dc;
        margin-top: 4px;
      }

      /* Timers */
      .timer {
        font-size: 2rem;
        text-align: center;
        margin: 6px 0;
      }
      .timer-controls {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }
      .timer-controls button {
        flex: 1;
        background: #263238;
      }

      /* HYPO */
      .hypo-step {
        border: 1px dashed #3a3f4a;
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 8px;
        background: #0f1116;
      }
      .hypo-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      @media (max-width: 600px) {
        .rings {
          grid-template-columns: 1fr;
        }
        .exercise-header {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Athletic Cut Coach</h1>
      <p>Upper/Lower 8 semanas · Cardio diario · Hipopro · Sin crunch</p>
      <div class="tabs">
        <button class="tab-btn active" data-tab="dashboard">Dashboard</button>
        <button class="tab-btn" data-tab="comidas">Comidas</button>
        <button class="tab-btn" data-tab="hipo">Hipo</button>
        <button class="tab-btn" data-tab="pesas">Pesas</button>
        <button class="tab-btn" data-tab="cardio">Cardio</button>
      </div>
    </header>

    <main>
      <!-- DASHBOARD -->
      <section id="dashboard" class="">
        <section class="card">
          <h2>Resumen estilo Apple Fitness</h2>
          <div class="view-toggle">
            <button class="secondary active" data-view="day">Día</button>
            <button class="secondary" data-view="week">Semana</button>
            <button class="secondary" data-view="month">Mes</button>
          </div>
          <div class="rings">
            <div class="ring-card">
              <div class="ring-label">Kcal consumidas</div>
              <div class="ring" id="ringKcal">
                <div class="ring-inner" id="ringKcalInner">0 kcal</div>
              </div>
              <div class="ring-value" id="ringKcalText"></div>
            </div>
            <div class="ring-card">
              <div class="ring-label">Cardio (min)</div>
              <div class="ring" id="ringCardio">
                <div class="ring-inner" id="ringCardioInner">0 min</div>
              </div>
              <div class="ring-value" id="ringCardioText"></div>
              <div class="ring-value small" id="ringFatZoneText"></div>
            </div>
            <div class="ring-card">
              <div class="ring-label">Pasos</div>
              <div class="ring" id="ringSteps">
                <div class="ring-inner" id="ringStepsInner">0 pasos</div>
              </div>
              <div class="ring-value" id="ringStepsText"></div>
            </div>
            <div class="ring-card">
              <div class="ring-label">Peso (kg)</div>
              <div class="ring" id="ringWeight">
                <div class="ring-inner" id="ringWeightInner">0 kg</div>
              </div>
              <div class="ring-value" id="ringWeightText"></div>
            </div>
          </div>
        </section>
        <section class="card">
          <h2>Historial</h2>
          <table class="history-table" id="historyTable">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Peso</th>
                <th>Cintura</th>
                <th>Kcal</th>
                <th>Cardio (min)</th>
                <th>FC prom</th>
                <th>Pasos</th>
                <th>Zona ox. (min)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>
      </section>

      <!-- COMIDAS -->
      <section id="comidas" class="hidden">
        <section class="card">
          <h2>Registro de comidas</h2>
          <p class="sub">Objetivo diario por defecto: 1600 kcal.</p>
          <label>
            Nombre de la comida
            <input
              id="mealNameInput"
              placeholder="Desayuno / Comida / Cena / Snack"
            />
          </label>
          <label>
            Kcal de esta comida
            <input id="kcalInput" type="number" min="0" step="1" />
          </label>
          <label>
            Peso (kg)
            <input id="weightInput" type="number" step="0.1" />
          </label>
          <label>
            Cintura (cm)
            <input id="waistInput" type="number" step="0.5" />
          </label>
          <button id="saveDaily">Agregar comida / actualizar día</button>
          <p id="dailyStatus" class="small"></p>
          <div id="mealsList"></div>
        </section>
      </section>

      <!-- HIPO -->
      <section id="hipo" class="hidden">
        <section class="card">
          <h2>Hipopresivos – Rutina guiada</h2>
          <p class="sub">
            Días recomendados: 3 y 7 (y cuando quieras en ayuno). Sin crunch,
            orientado a vientre plano.
          </p>

          <div class="hypo-step">
            <div class="hypo-head">
              <strong>1) Standing – Basic</strong>
              <span class="small">3 rondas · 40s trabajo / 20s transición</span>
            </div>
            <p class="small">
              Postura erguida, pies al ancho de cadera, brazos ligeramente
              activos.
            </p>
          </div>

          <div class="hypo-step">
            <div class="hypo-head">
              <strong>2) Seated – Open elbows</strong>
              <span class="small">3 rondas · 40s / 20s</span>
            </div>
            <p class="small">
              Sentado al borde, columna larga, codos abiertos en línea con
              hombros.
            </p>
          </div>

          <div class="hypo-step">
            <div class="hypo-head">
              <strong>3) Quadruped – Neutral spine</strong>
              <span class="small">3 rondas · 40s / 20s</span>
            </div>
            <p class="small">
              Apoyo de manos y rodillas, columna neutra, cuello relajado.
            </p>
          </div>

          <div class="timer"><span id="hypoTimer">00:00</span></div>
          <div class="timer-controls">
            <button class="secondary" id="startHypo">
              Iniciar rutina guiada
            </button>
            <button class="secondary" id="stopHypo">Detener</button>
          </div>
          <p class="small">
            Dentro de cada bloque de 40s: inspira 4s → apnea → suelta y repite
            según tolerancia. El temporizador recorre 3 posturas × 3 rondas con
            20s de transición.
          </p>
          <p id="hypoStatus" class="small"></p>
        </section>
      </section>

      <!-- PESAS -->
      <section id="pesas" class="hidden">
        <section class="card">
          <h2>Pesas – Upper/Lower 8 semanas</h2>
          <p class="sub">
            Selecciona el día. Al escribir un peso en una serie, se guarda y
            arranca automáticamente el descanso sugerido.
          </p>
          <label>
            Día de rutina
            <select id="daySelect">
              <option value="1">Día 1 – Upper A (pecho prioridad)</option>
              <option value="2">Día 2 – Lower A (quad prioridad)</option>
              <option value="3">Día 3 – Upper B (estética torso)</option>
              <option value="4">Día 4 – Lower B (femoral + glúteo)</option>
              <option value="5">
                Día 5 – Extra (usa pestañas Cardio + Hipo)
              </option>
              <option value="6">Día 6 – Libre / movilidad</option>
              <option value="7">Día 7 – Descanso activo</option>
            </select>
          </label>
          <p class="tempo-note">
            Tempo A–B–C–D =
            <strong>A:</strong> bajar · <strong>B:</strong> pausa abajo ·
            <strong>C:</strong> subir · <strong>D:</strong> pausa arriba.
            Ejemplo <code>3–1–1–0</code> = 3s bajando, 1s abajo, 1s subiendo,
            0s arriba.
          </p>
        </section>

        <section class="card">
          <h2>Rutina del día</h2>
          <div id="exerciseList"></div>
        </section>

        <section class="card">
          <h2>Descanso</h2>
          <div class="timer"><span id="timerDisplay">00:00</span></div>
          <div class="timer-controls">
            <button data-time="45" class="secondary">45s</button>
            <button data-time="60" class="secondary">60s</button>
            <button data-time="90" class="secondary">90s</button>
            <button id="stopTimer">Stop</button>
          </div>
          <p class="small">
            El temporizador también arranca cuando registras el peso de una
            serie (usa el descanso del ejercicio).
          </p>
        </section>
      </section>

      <!-- CARDIO -->
      <section id="cardio" class="hidden">
        <section class="card">
          <h2>Registro de cardio</h2>
          <p class="sub" id="fatZoneInfo"></p>
          <label>
            Modalidad (walk incline / bike / row / eliptica)
            <input id="cardioType" />
          </label>
          <label>
            Tiempo de esta sesión (min)
            <input id="cardioTime" type="number" min="0" step="1" />
          </label>
          <label>
            FC media (bpm)
            <input id="cardioHR" type="number" min="0" step="1" />
          </label>
          <label>
            Pasos de esta sesión
            <input id="stepsInput" type="number" min="0" step="1" />
          </label>
          <button id="saveCardio">Guardar cardio</button>
          <p id="cardioStatus" class="small"></p>
          <div id="cardioSessionsList"></div>
        </section>
      </section>
    </main>

    <script>
      /* =============== PARÁMETROS GENERALES =============== */
      const AGE = 27;
      const HR_MAX = Math.round(208 - 0.7 * AGE);
      const HR_FAT_LOW = Math.round(HR_MAX * 0.6);
      const HR_FAT_HIGH = Math.round(HR_MAX * 0.75);
      const TARGET_FAT_MIN = 30;

      const TARGET_KCAL = 1600;
      const TARGET_CARDIO_MIN = 30;
      const TARGET_STEPS = 8000;

      function todayKey() {
        return new Date().toISOString().slice(0, 10);
      }
      function isInFatZone(hr) {
        if (!hr || isNaN(hr)) return false;
        return hr >= HR_FAT_LOW && hr <= HR_FAT_HIGH;
      }

      /* =============== TABS =============== */
      const tabBtns = document.querySelectorAll(".tab-btn");
      const sections = {
        dashboard: document.getElementById("dashboard"),
        comidas: document.getElementById("comidas"),
        hipo: document.getElementById("hipo"),
        pesas: document.getElementById("pesas"),
        cardio: document.getElementById("cardio"),
      };

      tabBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          tabBtns.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          const tab = btn.dataset.tab;
          Object.keys(sections).forEach((k) => {
            sections[k].classList.toggle("hidden", k !== tab);
          });
          if (tab === "dashboard") updateDashboard();
          if (tab === "cardio") renderCardioSessionsToday();
          if (tab === "comidas") renderMealsToday();
        });
      });

      /* =============== RUTINA UPPER/LOWER =============== */
      // name, sets, reps, tempo, rest (texto tipo "90s")
      const routineByDay = {
        1: [
          // Upper A
          {
            name: "Press inclinado mancuernas",
            sets: "4",
            reps: "8–10",
            tempo: "3-1-1-0",
            rest: "120s",
          },
          {
            name: "Press plano máquina convergente",
            sets: "3",
            reps: "10–12",
            tempo: "3-0-2-1",
            rest: "120s",
          },
          {
            name: "Press declinado DB / máquina",
            sets: "3",
            reps: "8–10",
            tempo: "2-0-2-0",
            rest: "120s",
          },
          {
            name: "Aperturas en polea (alto–bajo)",
            sets: "3",
            reps: "12–15",
            tempo: "2-1-3-1",
            rest: "90s",
          },
          {
            name: "Laterales en polea",
            sets: "3",
            reps: "12–15",
            tempo: "2-1-2-0",
            rest: "75s",
          },
          {
            name: "Posterior en polea",
            sets: "2",
            reps: "12–15",
            tempo: "2-0-3-1",
            rest: "75s",
          },
          {
            name: "Remo sentado neutro",
            sets: "3",
            reps: "10–12",
            tempo: "2-1-2-1",
            rest: "120s",
          },
          {
            name: "Jalón neutro",
            sets: "2",
            reps: "10–12",
            tempo: "2-1-2-0",
            rest: "120s",
          },
          {
            name: "Curl EZ",
            sets: "2",
            reps: "10–12",
            tempo: "2-0-2-1",
            rest: "75s",
          },
          {
            name: "Tríceps cuerda",
            sets: "2",
            reps: "12–15",
            tempo: "2-0-2-1",
            rest: "75s",
          },
        ],
        2: [
          // Lower A
          {
            name: "Prensa",
            sets: "4",
            reps: "10–12",
            tempo: "3-1-2-0",
            rest: "150s",
          },
          {
            name: "Sentadilla goblet",
            sets: "3",
            reps: "8–10",
            tempo: "3-1-1-0",
            rest: "120s",
          },
          {
            name: "Extensión de cuádriceps",
            sets: "3",
            reps: "12–15",
            tempo: "2-1-3-1",
            rest: "90s",
          },
          {
            name: "Curl femoral sentado",
            sets: "3",
            reps: "10–12",
            tempo: "2-1-2-1",
            rest: "120s",
          },
          {
            name: "Peso muerto rumano mancuernas",
            sets: "3",
            reps: "8–10",
            tempo: "3-1-2-0",
            rest: "150s",
          },
          {
            name: "Hip thrust en máquina",
            sets: "3",
            reps: "10–12",
            tempo: "2-1-1-2",
            rest: "120s",
          },
          {
            name: "Gemelos sentado",
            sets: "3–4",
            reps: "12–15",
            tempo: "2-2-2-0",
            rest: "75s",
          },
        ],
        3: [
          // Upper B
          {
            name: "Press inclinado máquina",
            sets: "4",
            reps: "8–10",
            tempo: "3-0-2-1",
            rest: "150s",
          },
          {
            name: "Press plano DB",
            sets: "3",
            reps: "8–10",
            tempo: "3-0-2-0",
            rest: "120s",
          },
          {
            name: "Aperturas máquina / cable",
            sets: "3",
            reps: "12–15",
            tempo: "2-1-3-1",
            rest: "90s",
          },
          {
            name: "Laterales DB sentado",
            sets: "3",
            reps: "15–20",
            tempo: "2-1-2-0",
            rest: "75s",
          },
          {
            name: "Remo DB una mano",
            sets: "3",
            reps: "8–10",
            tempo: "2-1-2-1",
            rest: "120s",
          },
          {
            name: "Pull-ins polea",
            sets: "2",
            reps: "12–15",
            tempo: "2-1-3-1",
            rest: "90s",
          },
          {
            name: "Fondos asistidos",
            sets: "2",
            reps: "10–12",
            tempo: "2-0-2-1",
            rest: "90s",
          },
          {
            name: "Curl inclinado",
            sets: "2",
            reps: "10–12",
            tempo: "3-1-2-0",
            rest: "90s",
          },
        ],
        4: [
          // Lower B
          {
            name: "Peso muerto rumano mancuernas",
            sets: "3",
            reps: "8–10",
            tempo: "3-1-2-0",
            rest: "150s",
          },
          {
            name: "Prensa pies arriba",
            sets: "3",
            reps: "10–12",
            tempo: "3-1-2-0",
            rest: "150s",
          },
          {
            name: "Zancadas caminando",
            sets: "3",
            reps: "10–12 por pierna",
            tempo: "2-0-2-0",
            rest: "90s",
          },
          {
            name: "Curl femoral",
            sets: "3",
            reps: "10–12",
            tempo: "2-1-2-1",
            rest: "120s",
          },
          {
            name: "Gemelos (de pie o sentado)",
            sets: "3",
            reps: "12–15",
            tempo: "2-2-2-0",
            rest: "75s",
          },
        ],
        5: [], // Día extra
        6: [],
        7: [],
      };

      const daySelect = document.getElementById("daySelect");
      const exerciseList = document.getElementById("exerciseList");

      function getSetsCount(setsText) {
        if (!setsText) return 3;
        const m = String(setsText).match(/\d+/);
        return m ? parseInt(m[0], 10) : 3;
      }
      function parseRestSeconds(restText) {
        if (!restText) return 60;
        const m = String(restText).match(/\d+/);
        return m ? parseInt(m[0], 10) : 60;
      }

      function loadDayExercises(day) {
        exerciseList.innerHTML = "";
        const exercises = routineByDay[day] || [];
        if (!exercises.length) {
          const p = document.createElement("p");
          p.className = "small";
          if (day === 5) {
            p.innerHTML =
              "Día extra: utiliza <strong>Cardio</strong> e <strong>Hipo</strong> según te sientas. También puedes hacer movilidad ligera.";
          } else if (day === 7) {
            p.innerHTML =
              "Descanso activo: caminata suave 30–40 min + hipopresivos en ayuno si te sientan bien.";
          } else {
            p.textContent = "Día libre / movilidad / recuperación.";
          }
          exerciseList.appendChild(p);
          return;
        }

        const savedKey = `day_${day}_log`;
        const savedData = JSON.parse(localStorage.getItem(savedKey) || "{}");

        exercises.forEach((ex, index) => {
          const card = document.createElement("div");
          card.className = "exercise-card";

          const header = document.createElement("div");
          header.className = "exercise-header";

          const left = document.createElement("div");
          left.className = "exercise-header-left";
          left.innerHTML = `<span><strong>${ex.name}</strong></span>
            <span class="exercise-meta">${ex.sets} x ${
            ex.reps
          } · Tempo ${ex.tempo} · Descanso ${ex.rest}</span>`;

          header.appendChild(left);
          card.appendChild(header);

          const inputsWrap = document.createElement("div");
          inputsWrap.className = "exercise-inputs";
          const setsRow = document.createElement("div");
          setsRow.className = "sets-row";

          const setsCount = getSetsCount(ex.sets);
          const savedEntry = savedData[index] || {};
          const savedWeights = savedEntry.weights || [];
          const restSeconds = parseRestSeconds(ex.rest);

          for (let s = 0; s < setsCount; s++) {
            const setInput = document.createElement("input");
            setInput.type = "number";
            setInput.min = "0";
            setInput.step = "0.5";
            setInput.placeholder = `S${s + 1} kg`;
            setInput.className = "set-weight";
            setInput.value =
              savedWeights[s] !== undefined ? savedWeights[s] : 0;
            setInput.addEventListener("change", () => {
              saveExerciseLog(day);
              if (restSeconds > 0) startTimer(restSeconds);
            });
            setsRow.appendChild(setInput);
          }

          const notes = document.createElement("input");
          notes.placeholder = "Notas (RPE, fallo, técnica)";
          notes.value = savedEntry.notes || "";
          notes.addEventListener("change", () => saveExerciseLog(day));

          inputsWrap.appendChild(setsRow);
          inputsWrap.appendChild(notes);
          card.appendChild(inputsWrap);
          exerciseList.appendChild(card);
        });
      }

      function saveExerciseLog(day) {
        const cards = exerciseList.querySelectorAll(".exercise-card");
        const data = [];
        cards.forEach((card) => {
          const setInputs = card.querySelectorAll(".set-weight");
          const notes = card.querySelector(
            'input[placeholder^="Notas (RPE"]'
          );
          const weights = Array.from(setInputs).map((i) => i.value);
          data.push({ weights, notes: notes ? notes.value : "" });
        });
        localStorage.setItem(`day_${day}_log`, JSON.stringify(data));
      }

      daySelect.addEventListener("change", (e) => {
        loadDayExercises(parseInt(e.target.value, 10));
      });
      loadDayExercises(parseInt(daySelect.value, 10));

      /* =============== TIMER PESAS (persistente) =============== */
      let timerInterval = null,
        remainingSeconds = 0;
      const timerDisplay = document.getElementById("timerDisplay");
      const TIMER_STORAGE_KEY = "rest_timer_v1";
      let audioCtx = null;

      function initAudio() {
        if (audioCtx) return;
        const AC = window.AudioContext || window.webkitAudioContext || null;
        if (!AC) return;
        audioCtx = new AC();
      }
      function playBeep() {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = "sine";
        osc.frequency.value = 880;
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;
        gain.gain.setValueAtTime(0.0001, now);
        gain.gain.exponentialRampToValueAtTime(0.3, now + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.5);
        osc.start(now);
        osc.stop(now + 0.5);
      }
      function updateTimerDisplay() {
        const m = String(Math.floor(remainingSeconds / 60)).padStart(2, "0");
        const s = String(remainingSeconds % 60).padStart(2, "0");
        timerDisplay.textContent = `${m}:${s}`;
      }
      function tickTimer() {
        const raw = localStorage.getItem(TIMER_STORAGE_KEY);
        if (!raw) {
          remainingSeconds = 0;
          updateTimerDisplay();
          clearInterval(timerInterval);
          return;
        }
        const data = JSON.parse(raw);
        if (!data.active || !data.endTime) {
          localStorage.removeItem(TIMER_STORAGE_KEY);
          remainingSeconds = 0;
          updateTimerDisplay();
          clearInterval(timerInterval);
          return;
        }
        const diff = Math.round((data.endTime - Date.now()) / 1000);
        if (diff <= 0) {
          remainingSeconds = 0;
          updateTimerDisplay();
          localStorage.removeItem(TIMER_STORAGE_KEY);
          clearInterval(timerInterval);
          if (navigator.vibrate) navigator.vibrate(200);
          playBeep();
        } else {
          remainingSeconds = diff;
          updateTimerDisplay();
        }
      }
      function startTimer(seconds) {
        initAudio();
        const endTime = Date.now() + seconds * 1000;
        localStorage.setItem(
          TIMER_STORAGE_KEY,
          JSON.stringify({ active: true, endTime })
        );
        clearInterval(timerInterval);
        tickTimer();
        timerInterval = setInterval(tickTimer, 1000);
      }
      function stopTimer() {
        localStorage.removeItem(TIMER_STORAGE_KEY);
        clearInterval(timerInterval);
        remainingSeconds = 0;
        updateTimerDisplay();
      }

      document
        .querySelectorAll(".timer-controls button[data-time]")
        .forEach((btn) => {
          btn.addEventListener("click", () => {
            startTimer(parseInt(btn.dataset.time, 10));
          });
        });
      document.getElementById("stopTimer").addEventListener("click", stopTimer);

      (function restoreTimer() {
        const raw = localStorage.getItem(TIMER_STORAGE_KEY);
        if (!raw) {
          remainingSeconds = 0;
          updateTimerDisplay();
          return;
        }
        const data = JSON.parse(raw);
        if (!data.active || !data.endTime || data.endTime <= Date.now()) {
          localStorage.removeItem(TIMER_STORAGE_KEY);
          remainingSeconds = 0;
          updateTimerDisplay();
          return;
        }
        tickTimer();
        clearInterval(timerInterval);
        timerInterval = setInterval(tickTimer, 1000);
      })();

      /* =============== HIPO – Rutina guiada =============== */
      const hypoTimerEl = document.getElementById("hypoTimer");
      const startHypo = document.getElementById("startHypo");
      const stopHypo = document.getElementById("stopHypo");
      const hypoStatus = document.getElementById("hypoStatus");

      let hypoInt = null,
        hypoRemaining = 0,
        hypoIndex = 0,
        hypoActive = false;
      const HYPO_WORK = 40,
        HYPO_REST = 20;
      const hypoSequence = [
        { name: "Standing – Basic" },
        { name: "Seated – Open elbows" },
        { name: "Quadruped – Neutral spine" },
      ];
      let fullProgram = [];

      function buildHypoProgram() {
        fullProgram = [];
        for (let round = 1; round <= 3; round++) {
          for (let i = 0; i < hypoSequence.length; i++) {
            fullProgram.push({
              type: "work",
              seconds: HYPO_WORK,
              label: `${hypoSequence[i].name} · Ronda ${round}/3`,
            });
            if (!(round === 3 && i === hypoSequence.length - 1)) {
              fullProgram.push({
                type: "rest",
                seconds: HYPO_REST,
                label: "Transición / recuperación",
              });
            }
          }
        }
      }
      function formatTime(s) {
        const m = String(Math.floor(s / 60)).padStart(2, "0");
        const ss = String(s % 60).padStart(2, "0");
        return `${m}:${ss}`;
      }
      function renderHypo() {
        hypoTimerEl.textContent = formatTime(hypoRemaining);
        const step = fullProgram[hypoIndex];
        if (step) {
          hypoStatus.textContent = `${
            step.type === "work" ? "Trabajo: " : "Descanso: "
          }${step.label}`;
        }
      }
      function tickHypo() {
        hypoRemaining--;
        if (hypoRemaining <= 0) {
          if (navigator.vibrate) navigator.vibrate(150);
          playBeep();
          hypoIndex++;
          if (hypoIndex >= fullProgram.length) {
            clearInterval(hypoInt);
            hypoActive = false;
            hypoStatus.textContent = "Rutina finalizada ✅";
            return;
          }
          const next = fullProgram[hypoIndex];
          hypoRemaining = next.seconds;
          renderHypo();
        } else {
          renderHypo();
        }
      }
      startHypo.addEventListener("click", () => {
        if (hypoActive) return;
        initAudio();
        buildHypoProgram();
        hypoIndex = 0;
        hypoRemaining = fullProgram[0].seconds;
        renderHypo();
        hypoActive = true;
        clearInterval(hypoInt);
        hypoInt = setInterval(tickHypo, 1000);
      });
      stopHypo.addEventListener("click", () => {
        clearInterval(hypoInt);
        hypoActive = false;
        hypoStatus.textContent = "Rutina detenida.";
      });

      /* =============== CARDIO =============== */
      const fatZoneInfo = document.getElementById("fatZoneInfo");
      if (fatZoneInfo)
        fatZoneInfo.textContent = `Zona de oxidación estimada: ${HR_FAT_LOW}-${HR_FAT_HIGH} bpm (60–75% FC máx).`;

      const cardioType = document.getElementById("cardioType");
      const cardioTime = document.getElementById("cardioTime");
      const cardioHR = document.getElementById("cardioHR");
      const stepsInput = document.getElementById("stepsInput");
      const saveCardioBtn = document.getElementById("saveCardio");
      const cardioStatus = document.getElementById("cardioStatus");
      const cardioSessionsList = document.getElementById("cardioSessionsList");

      saveCardioBtn.addEventListener("click", () => {
        const key = todayKey();
        const existing = JSON.parse(
          localStorage.getItem(`cardio_${key}`) || "{}"
        );
        const newTime = parseFloat(cardioTime.value || "0");
        const newHR = parseFloat(cardioHR.value || "0");
        const newSteps = parseInt(stepsInput.value || "0", 10);
        const newType =
          cardioType.value || `Sesión ${(existing.sessions || []).length + 1}`;

        const totalBefore = existing.time || 0;
        const totalAfter = totalBefore + newTime;

        let hrAvg = existing.hr || 0;
        if (totalAfter > 0) {
          hrAvg =
            ((existing.hr || 0) * totalBefore + (newHR || 0) * newTime) /
            totalAfter;
        }
        const inZone = isInFatZone(newHR) ? newTime : 0;

        const sessions = existing.sessions || [];
        sessions.push({
          type: newType,
          time: newTime,
          hr: newHR,
          steps: newSteps,
          timeInFatZone: inZone,
        });

        const payload = {
          type: newType,
          time: totalAfter,
          hr: hrAvg,
          steps: (existing.steps || 0) + (newSteps || 0),
          timeInFatZone: (existing.timeInFatZone || 0) + inZone,
          sessions,
        };
        localStorage.setItem(`cardio_${key}`, JSON.stringify(payload));
        cardioStatus.textContent = "Cardio acumulado ✅";
        setTimeout(() => (cardioStatus.textContent = ""), 2000);

        cardioType.value = "";
        cardioTime.value = "";
        cardioHR.value = "";
        stepsInput.value = "";
        renderCardioSessionsToday();
        updateDashboard();
      });

      function renderCardioSessionsToday() {
        const key = todayKey();
        const data = JSON.parse(localStorage.getItem(`cardio_${key}`) || "{}");
        const sessions = data.sessions || [];
        if (!sessions.length) {
          cardioSessionsList.innerHTML =
            "<p class='small'>Sin sesiones registradas hoy.</p>";
          return;
        }
        let html =
          "<table class='history-table'><thead><tr><th>#</th><th>Tipo</th><th>Min</th><th>FC</th><th>Pasos</th><th>Zona ox. (min)</th></tr></thead><tbody>";
        sessions.forEach((s, i) => {
          const z =
            typeof s.timeInFatZone === "number"
              ? s.timeInFatZone
              : isInFatZone(s.hr)
              ? s.time
              : 0;
          html += `<tr>
            <td>${i + 1}</td>
            <td>${s.type || ""}</td>
            <td>${s.time || 0}</td>
            <td>${s.hr || 0}</td>
            <td>${s.steps || 0}</td>
            <td>${z || 0}</td>
          </tr>`;
        });
        html += "</tbody></table>";
        cardioSessionsList.innerHTML = html;
      }
      renderCardioSessionsToday();

      /* =============== COMIDAS =============== */
      const mealNameInput = document.getElementById("mealNameInput");
      const kcalInput = document.getElementById("kcalInput");
      const weightInput = document.getElementById("weightInput");
      const waistInput = document.getElementById("waistInput");
      const saveDailyBtn = document.getElementById("saveDaily");
      const dailyStatus = document.getElementById("dailyStatus");
      const mealsList = document.getElementById("mealsList");

      function renderMealsToday() {
        const key = todayKey();
        const meals = JSON.parse(localStorage.getItem(`meals_${key}`) || "[]");
        if (!meals.length) {
          mealsList.innerHTML =
            "<p class='small'>Sin comidas registradas todavía.</p>";
          return;
        }
        let html =
          "<table class='history-table'><thead><tr><th>#</th><th>Comida</th><th>Kcal</th></tr></thead><tbody>";
        meals.forEach((m, i) => {
          html += `<tr>
            <td>${i + 1}</td>
            <td>${m.name || `Comida ${i + 1}`}</td>
            <td>${m.kcal || 0}</td>
          </tr>`;
        });
        html += "</tbody></table>";
        mealsList.innerHTML = html;
      }

      saveDailyBtn.addEventListener("click", () => {
        const key = todayKey();
        const existingDaily = JSON.parse(
          localStorage.getItem(`daily_${key}`) || "{}"
        );
        const existingMeals = JSON.parse(
          localStorage.getItem(`meals_${key}`) || "[]"
        );

        const addKcal = parseFloat(kcalInput.value || "0");
        const mealName =
          mealNameInput.value || `Comida ${existingMeals.length + 1}`;

        const newMeals = [...existingMeals, { name: mealName, kcal: addKcal }];
        const payloadDaily = {
          weight: parseFloat(weightInput.value || existingDaily.weight || "0"),
          waist: parseFloat(waistInput.value || existingDaily.waist || "0"),
          kcal: (existingDaily.kcal || 0) + (addKcal || 0),
        };

        localStorage.setItem(`daily_${key}`, JSON.stringify(payloadDaily));
        localStorage.setItem(`meals_${key}`, JSON.stringify(newMeals));

        dailyStatus.textContent = "Comida agregada / día actualizado ✅";
        setTimeout(() => (dailyStatus.textContent = ""), 2000);

        mealNameInput.value = "";
        kcalInput.value = "";
        renderMealsToday();
        updateDashboard();
      });

      renderMealsToday();

      /* =============== DASHBOARD =============== */
      const ringKcal = document.getElementById("ringKcal");
      const ringCardio = document.getElementById("ringCardio");
      const ringSteps = document.getElementById("ringSteps");
      const ringWeight = document.getElementById("ringWeight");
      const ringKcalInner = document.getElementById("ringKcalInner");
      const ringCardioInner = document.getElementById("ringCardioInner");
      const ringStepsInner = document.getElementById("ringStepsInner");
      const ringWeightInner = document.getElementById("ringWeightInner");
      const ringKcalText = document.getElementById("ringKcalText");
      const ringCardioText = document.getElementById("ringCardioText");
      const ringStepsText = document.getElementById("ringStepsText");
      const ringWeightText = document.getElementById("ringWeightText");
      const ringFatZoneText = document.getElementById("ringFatZoneText");
      const historyTableBody = document.querySelector("#historyTable tbody");
      const viewButtons = document.querySelectorAll(".view-toggle button");

      let currentView = "day";
      viewButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          viewButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          currentView = btn.dataset.view;
          updateDashboard();
        });
      });

      function getLastNDates(n) {
        const dates = [];
        const today = new Date();
        for (let i = 0; i < n; i++) {
          const d = new Date(today);
          d.setDate(today.getDate() - i);
          dates.push(d.toISOString().slice(0, 10));
        }
        return dates.reverse();
      }
      function getDataRange(view) {
        let days = 1;
        if (view === "week") days = 7;
        if (view === "month") days = 30;
        const dates = getLastNDates(days);
        const rows = [];
        dates.forEach((date) => {
          const daily = JSON.parse(
            localStorage.getItem(`daily_${date}`) || "{}"
          );
          const cardio = JSON.parse(
            localStorage.getItem(`cardio_${date}`) || "{}"
          );
          if (
            daily.weight ||
            daily.waist ||
            daily.kcal ||
            cardio.time ||
            cardio.hr ||
            cardio.steps ||
            cardio.timeInFatZone
          ) {
            rows.push({
              date,
              weight: daily.weight || 0,
              waist: daily.waist || 0,
              kcal: daily.kcal || 0,
              cardioTime: cardio.time || 0,
              hr: cardio.hr || 0,
              steps: cardio.steps || 0,
              fatZoneMin: cardio.timeInFatZone || 0,
            });
          }
        });
        return rows;
      }
      function setRing(ringEl, innerEl, textEl, value, target, color, unit) {
        const percent = target > 0 ? Math.min(value / target, 1) : 0;
        ringEl.style.setProperty("--percent", percent.toString());
        ringEl.style.setProperty("--color", color);
        innerEl.textContent = `${Math.round(value)} ${unit}`;
        if (unit === "kg") {
          textEl.textContent = "Promedio / día";
        } else {
          textEl.textContent = `${Math.round(percent * 100)}% del objetivo`;
        }
      }
      function updateDashboard() {
        const data = getDataRange(currentView);
        if (!data.length) {
          setRing(
            ringKcal,
            ringKcalInner,
            ringKcalText,
            0,
            TARGET_KCAL,
            "#e53935",
            "kcal"
          );
          setRing(
            ringCardio,
            ringCardioInner,
            ringCardioText,
            0,
            TARGET_CARDIO_MIN,
            "#42a5f5",
            "min"
          );
          ringFatZoneText.textContent = "0 min en zona ox. (0% objetivo)";
          setRing(
            ringSteps,
            ringStepsInner,
            ringStepsText,
            0,
            TARGET_STEPS,
            "#66bb6a",
            "pasos"
          );
          setRing(
            ringWeight,
            ringWeightInner,
            ringWeightText,
            0,
            1,
            "#f5f5f5",
            "kg"
          );
          historyTableBody.innerHTML =
            "<tr><td colspan='8'>Sin datos aún. Registra tu día en las pestañas.</td></tr>";
          return;
        }
        let ref;
        if (currentView === "day") {
          ref = data[data.length - 1];
        } else {
          const sum = data.reduce(
            (a, r) => ({
              weight: a.weight + r.weight,
              waist: a.waist + r.waist,
              kcal: a.kcal + r.kcal,
              cardioTime: a.cardioTime + r.cardioTime,
              hr: a.hr + r.hr,
              steps: a.steps + r.steps,
              fatZoneMin: a.fatZoneMin + r.fatZoneMin,
            }),
            {
              weight: 0,
              waist: 0,
              kcal: 0,
              cardioTime: 0,
              hr: 0,
              steps: 0,
              fatZoneMin: 0,
            }
          );
          const len = data.length || 1;
          ref = {
            date: data[0].date + " → " + data[data.length - 1].date,
            weight: sum.weight / len,
            waist: sum.waist / len,
            kcal: sum.kcal / len,
            cardioTime: sum.cardioTime / len,
            hr: sum.hr / len,
            steps: sum.steps / len,
            fatZoneMin: sum.fatZoneMin / len,
          };
        }
        setRing(
          ringKcal,
          ringKcalInner,
          ringKcalText,
          ref.kcal || 0,
          TARGET_KCAL,
          "#e53935",
          "kcal"
        );
        setRing(
          ringCardio,
          ringCardioInner,
          ringCardioText,
          ref.cardioTime || 0,
          TARGET_CARDIO_MIN,
          "#42a5f5",
          "min"
        );
        const fatMin = ref.fatZoneMin || 0;
        const pctFat = Math.round(
          Math.min(fatMin / TARGET_FAT_MIN, 1) * 100
        );
        ringFatZoneText.textContent = `${Math.round(
          fatMin
        )} min en zona ox. (${pctFat}% objetivo)`;
        setRing(
          ringSteps,
          ringStepsInner,
          ringStepsText,
          ref.steps || 0,
          TARGET_STEPS,
          "#66bb6a",
          "pasos"
        );
        setRing(
          ringWeight,
          ringWeightInner,
          ringWeightText,
          ref.weight || 0,
          ref.weight || 1,
          "#f5f5f5",
          "kg"
        );

        historyTableBody.innerHTML = "";
        data.forEach((row) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.date}</td>
            <td>${row.weight || ""}</td>
            <td>${row.waist || ""}</td>
            <td>${row.kcal || ""}</td>
            <td>${row.cardioTime || ""}</td>
            <td>${row.hr || ""}</td>
            <td>${row.steps || ""}</td>
            <td>${row.fatZoneMin || ""}</td>
          `;
          historyTableBody.appendChild(tr);
        });
      }
      updateDashboard();
    </script>
  </body>
</html>
